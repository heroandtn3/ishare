{% extends 'ishare/base.html' %}

{% block content %}
<div class="row">
  <div class="col-md-8">
    <div class="panel panel-info">
      <div class="panel-heading">
        <h3 class="panel-title">{{ image.title }}
        {% if user.is_authenticated %}
        <div class="btn-group btn-group-xs pull-right" role="group">
          <button id="voteup-btn" type="button" class="btn btn-success" {% if is_vote_up == True %} disabled="disabled" {% endif %}>
            <span class="glyphicon glyphicon-thumbs-up"></span> <span id="voteup-number">{{ image.voteup_number }}</span>
          </button>
          <button id="votedown-btn" type="button" class="btn btn-danger" {% if is_vote_up == False %} disabled="disabled" {% endif %}>
            <span class="glyphicon glyphicon-thumbs-down"></span> <span id="votedown-number">{{ image.votedown_number }}</span>
          </button>
        </div>
        {% endif %} 
        </h3>
        
      </div>
      <div class="panel-body">
        <div class="row">
          <div class="col-md-12">
            <img style="max-width: 100%" src="{% url 'ishare:photo_direct' image.pk %}">
          </div>
        </div>

      </div>
    </div>
  </div><!--/Image-->

  <div class="col-md-4">
    <div class="panel panel-info">
      <div class="panel-heading">
        <h3 class="panel-title">Information</h3>
      </div>
      <div class="panel-body">
        Uploader: {{ image.entity.creator.username }}
        <hr />
        Title: {{ image.title }}
        <hr />
        Views: {{ image.views }}
        <hr />
        Album: {{ image.album.title }}
      </div>
    </div>
  </div>
</div>

<div class="row">
  <div class="col-md-8">
    <div class="panel panel-info">
      <div class="panel-heading">
        <h3 class="panel-title">Comments</h3>
        
      </div>
      <div class="panel-body">
        <ul class="list-group" id="comment-list"></ul>
      </div>
    </div>
    {% if user.is_authenticated %}
    <div id="comment-box">
      <form role="form">
        <div id="menu" class="input-group">
          <textarea style="resize: none;" id="message" rows="2" class="form-control" placeholder="Enter message..." autofocus></textarea>
          <span class="input-group-addon">
            <button id="send-btn" class="btn btn-primary" type="button">
              Send
            </button>
          </span>
        </div>
      </form>
    </div>
    {% else %}
    <a href="{% url 'account:login' %}">Login to comment</a>
    {% endif %}
  </div><!--/Comment box-->
</div>

<script type="text/javascript">
  // using jQuery
  function getCookie(name) {
    var cookieValue = null;
    if (document.cookie && document.cookie != '') {
      var cookies = document.cookie.split(';');
      for (var i = 0; i < cookies.length; i++) {
        var cookie = jQuery.trim(cookies[i]);
        // Does this cookie string begin with the name we want?
        if (cookie.substring(0, name.length + 1) == (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  var csrftoken = getCookie('csrftoken');
  function csrfSafeMethod(method) {
    // these HTTP methods do not require CSRF protection
    return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
  }
  function sameOrigin(url) {
    // test that a given url is a same-origin URL
    // url could be relative or scheme relative or absolute
    var host = document.location.host; // host + port
    var protocol = document.location.protocol;
    var sr_origin = '//' + host;
    var origin = protocol + sr_origin;
    // Allow absolute or scheme relative URLs to same origin
    return (url == origin || url.slice(0, origin.length + 1) == origin + '/') ||
        (url == sr_origin || url.slice(0, sr_origin.length + 1) == sr_origin + '/') ||
        // or any other URL that isn't scheme relative or absolute i.e relative.
        !(/^(\/\/|http:|https:).*/.test(url));
  }
  $.ajaxSetup({
    beforeSend: function(xhr, settings) {
      if (!csrfSafeMethod(settings.type) && sameOrigin(settings.url)) {
        // Send the token to same-origin, relative URLs only.
        // Send the token only if the method warrants CSRF protection
        // Using the CSRFToken value acquired earlier
        xhr.setRequestHeader("X-CSRFToken", csrftoken);
      }
    }
  });
</script>
<script type="text/javascript">
  if (typeof(String.prototype.trim) === "undefined") {
    String.prototype.trim = function() {
        return String(this).replace(/^\s+|\s+$/g, '');
    };
  }

  function createCommentItem(comment) {
    var user = $('<a>').attr('href', '/u/' + comment.creator.id).text(comment.creator.name);
    var message = $('<span>').text(': ' + comment.content);
    var item = $('<li>').addClass('list-group-item').append(user).append(message);
    return item;
  }


  var commentList = $('#comment-list');
  var commentBox = $('#comment-box');
  var sendBtn = $('button#send-btn');
  var message = $('textarea#message');
  $.ajax({
    type: "GET",
    url: "{% url 'ishare:photo_json_recent_comment' image.pk %}",
    success: function (res) {
      console.log(res);
      for (var i = 0; i < res.length; i++) {
        var comment = res[i];
        commentList.append(createCommentItem(comment));
      }
    }
  });
  sendBtn.click(function () {
    var msg = message.val().trim();
    if (msg) {
      $.ajax({
        type: "POST",
        url: "{% url 'ishare:photo_json_send_comment' image.pk %}",
        data: { message: msg },
        success: function (res) {
          console.log(res);
          if (res.hasOwnProperty('error')) {
            alert(res.error.msg);
          } else {
            message.val('');
            commentList.append(createCommentItem(res));
            commentList.animate({ scrollTop: commentList[0].scrollHeight}, 1000);
          }
        }
      });
    }
  });

  // vote section
  var voteUpBtn = $('button#voteup-btn');
  var voteDownBtn = $('button#votedown-btn');
  var voteUpText = $('span#voteup-number');
  var voteDownText = $('span#votedown-number');

  function sendVote(isVoteUp) {
    $.ajax({
      type: "POST",
      url: "{% url 'ishare:photo_json_vote' image.pk %}",
      data: { is_vote_up: isVoteUp ? 1 : 0 },
      success: function (res) {
        console.log(res);
        if (res.hasOwnProperty('error')) {
          alert(res.error.msg);
        } else {
          voteUpText.text(res.voteUpNumber);
          voteDownText.text(res.voteDownNumber);
          if (isVoteUp) {
            voteUpBtn.attr('disabled', 'disabled');
            voteDownBtn.removeAttr('disabled');
          } else {
            voteDownBtn.attr('disabled', 'disabled');
            voteUpBtn.removeAttr('disabled');
          }
        }
      }
    });
  }
  voteUpBtn.click(function () { sendVote(true); });
  voteDownBtn.click(function () { sendVote(false); });

</script>
{% endblock %}